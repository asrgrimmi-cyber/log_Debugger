<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRC Log Analyzer - Phase 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .json-block {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Fira Code', 'Cascadia Code', monospace;
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #1a202c;
        }

        .json-block::-webkit-scrollbar {
            width: 8px;
        }

        .json-block::-webkit-scrollbar-track {
            background: #1a202c;
        }

        .json-block::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .feature-checkbox {
            accent-color: #3b82f6;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">
    <nav class="border-b border-slate-800 p-4 bg-slate-900 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-400 tracking-tighter">DEBUGGER <span
                    class="text-slate-500 font-light">v1.0</span></h1>
            <div class="text-[10px] text-slate-500 font-mono bg-slate-800 px-2 py-1 rounded">PHASE 1: FEATURE SELECTIVE
                ANALYSIS</div>
        </div>
    </nav>

    <form action="/analyze" method="post" enctype="multipart/form-data"
        class="bg-slate-800 border-b border-slate-700 shadow-inner">
        <div class="container mx-auto p-3 flex flex-wrap items-center gap-6">

            <div class="flex flex-col gap-1">
                <span class="text-[9px] uppercase font-bold text-slate-500">1. Source Log</span>
                <input type="file" name="file" required
                    class="text-xs bg-slate-900 rounded border border-slate-700 file:bg-slate-700 file:text-white file:border-0 file:px-3 file:py-1 cursor-pointer">
                {% if filename %}
                <span class="text-[9px] text-blue-400 italic">Last used: {{ filename }}</span>
                {% endif %}
            </div>

            <div class="flex flex-col gap-1 border-l border-slate-700 pl-6">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] uppercase font-bold text-blue-500 tracking-widest">2. General</span>
                    <button type="button" onclick="toggleGroup('gen', true)"
                        class="text-[8px] text-slate-500 hover:text-white underline ml-4">ALL</button>
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-blue-300">
                        <input type="checkbox" name="features" value="cell_identity" class="gen-check feature-checkbox"
                            {% if not selected_features or 'cell_identity' in selected_features %}checked{% endif %}>
                        Identity
                    </label>
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-blue-300">
                        <input type="checkbox" name="features" value="nr_band" class="gen-check feature-checkbox" {% if
                            not selected_features or 'nr_band' in selected_features %}checked{% endif %}> Band
                    </label>
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-blue-300">
                        <input type="checkbox" name="features" value="cell_barred" class="gen-check feature-checkbox" {%
                            if not selected_features or 'cell_barred' in selected_features %}checked{% endif %}> Barred
                    </label>
                </div>
            </div>

            <div class="flex flex-col gap-1 border-l border-slate-700 pl-6">
                <div class="flex justify-between items-center">
                    <span class="text-[9px] uppercase font-bold text-purple-500 tracking-widest">3. Feature
                        Specific</span>
                    <button type="button" onclick="toggleGroup('feat', true)"
                        class="text-[8px] text-slate-500 hover:text-white underline ml-4">ALL</button>
                </div>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-purple-300">
                        <input type="checkbox" name="features" value="ntn_config" class="feat-check feature-checkbox" {%
                            if selected_features and 'ntn_config' in selected_features %}checked{% endif %}> NTN
                    </label>
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-purple-300">
                        <input type="checkbox" name="features" value="ephemeris_pos" class="feat-check feature-checkbox"
                            {% if selected_features and 'ephemeris_pos' in selected_features %}checked{% endif %}>
                        Ephemeris
                    </label>
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-purple-300">
                        <input type="checkbox" name="features" value="timers" class="feat-check feature-checkbox" {% if
                            selected_features and 'timers' in selected_features %}checked{% endif %}> Timers
                    </label>
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-purple-300">
                        <input type="checkbox" name="features" value="scheduling" class="feat-check feature-checkbox" {%
                            if selected_features and 'scheduling' in selected_features %}checked{% endif %}> Scheduling
                    </label>
                    <label class="flex items-center gap-2 text-xs cursor-pointer hover:text-purple-300">
                        <input type="checkbox" name="features" value="radioBearerConfig"
                            class="feat-check feature-checkbox" {% if selected_features and 'radioBearerConfig' in
                            selected_features %}checked{% endif %}> radioBearerConfig
                    </label>
                </div>
            </div>

            <button type="submit"
                class="ml-auto bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded text-xs font-black transition transform active:scale-95 shadow-lg shadow-blue-900/20">
                RUN ANALYSIS
            </button>
        </div>
    </form>

    <main class="flex-1 flex overflow-hidden container mx-auto p-6 gap-6">
        <div class="w-1/3 flex flex-col gap-4">
            <div class="bg-slate-800 p-4 rounded-lg border border-slate-700 flex-1 overflow-y-auto">
                <h2 class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-widest italic">Log Summary</h2>
                {% if results %}
                {% for key, changes in results.items() %}
                <div
                    class="flex justify-between py-3 border-b border-slate-700/50 last:border-0 hover:bg-slate-700/30 px-2 rounded transition">
                    <span class="text-sm font-medium">{{ key }}</span>
                    <span
                        class="bg-blue-900/50 text-blue-300 border border-blue-700 px-2 rounded-md text-[10px] flex items-center italic">
                        {{ changes|length }} STATES
                    </span>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-slate-600 text-sm italic">Configure features and upload a log to begin.</p>
                {% endif %}
            </div>

            <div class="bg-slate-950 border-l-4 border-blue-500 p-3 rounded shadow-lg">
                <p class="text-[10px] uppercase text-slate-500 font-bold tracking-tighter">Current Active Log:</p>
                <p class="text-sm text-blue-200 truncate font-mono">{{ filename if filename else 'No file loaded' }}</p>
            </div>
        </div>

        <div class="w-2/3 flex flex-col bg-slate-800 rounded-lg border border-slate-700 overflow-hidden shadow-2xl">
            <div
                class="bg-slate-700 px-4 py-2 text-[10px] font-black uppercase tracking-widest flex justify-between items-center">
                <span>Live Detection Output</span>
                {% if json_str %}
                <button onclick="copyToClipboard()"
                    class="bg-slate-600 hover:bg-slate-500 px-2 py-0.5 rounded transition text-[9px]">COPY JSON</button>
                {% endif %}
            </div>

            <div id="jsonOutput" class="json-block flex-1 overflow-auto p-6 text-sm">
                {% if json_str %}
                <pre><code class="language-json">{{ json_str }}</code></pre>
                {% else %}
                <div class="h-full flex items-center justify-center text-slate-600 italic flex-col gap-2">
                    <svg class="w-8 h-8 opacity-20" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                        <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                    </svg>
                    <span>System idle. Awaiting log data...</span>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <footer
        class="bg-slate-950 border-t border-slate-800 px-6 py-1 flex justify-between items-center text-[10px] text-slate-500">
        <div>SYSTEM READY</div>
        <div class="flex gap-4">
            <span>MODE: SELECTIVE_ANALYSIS</span>
            <span>ENGINE: FASTAPI + PY3.13</span>
        </div>
    </footer>

    <script>
        // New Logic to prevent page refresh and keep the file selected
        const form = document.querySelector('form');
        form.onsubmit = async (e) => {
            e.preventDefault(); // Stop page from refreshing

            const formData = new FormData(form);
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });

            const newHtml = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(newHtml, 'text/html');

            // Only update the results and summary, NOT the file input
            document.querySelector('main').innerHTML = doc.querySelector('main').innerHTML;

            // Update the JSON string for the copy button
            if (doc.querySelector('code')) {
                document.getElementById('jsonOutput').innerHTML = doc.getElementById('jsonOutput').innerHTML;
            }
        };

        function toggleGroup(cls, state) {
            document.querySelectorAll('.' + cls + '-check').forEach(cb => cb.checked = state);
        }

        function copyToClipboard() {
            const text = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(text);
            alert("JSON copied to clipboard!");
        }
    </script>
</body>

</html>